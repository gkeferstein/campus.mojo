name: CI - Main Branch (Fast Pipeline)

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'docs/**'
      - 'scripts/**'
      - '.github/**'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '22'

jobs:
  # ============================================
  # PARALLEL CODE QUALITY CHECKS
  # ============================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    strategy:
      matrix:
        package:
          - name: api
            path: packages/api
          - name: frontend
            path: packages/frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.package.path }}/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Setup npm for GitHub Packages
        run: |
          # Ensure .npmrc exists and add GitHub Packages config
          if [ -f ~/.npmrc ]; then
            # Remove existing @gkeferstein registry line if present
            sed -i '/@gkeferstein:registry/d' ~/.npmrc
            sed -i '/npm.pkg.github.com\/:_authToken/d' ~/.npmrc
          fi
          echo "@gkeferstein:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "‚úÖ .npmrc configuration:"
          cat ~/.npmrc

      - name: Install Dependencies
        working-directory: ${{ matrix.package.path }}
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: TypeScript Compile Check
        working-directory: ${{ matrix.package.path }}
        run: npm run typecheck || npx tsc --noEmit

      - name: ESLint with Auto-Fix
        working-directory: ${{ matrix.package.path }}
        run: |
          npm run lint || echo "‚ö†Ô∏è Linting issues found"
        continue-on-error: true

      - name: Security Audit (High/Critical only)
        working-directory: ${{ matrix.package.path }}
        run: |
          npm audit --audit-level=high || echo "‚ö†Ô∏è Security vulnerabilities found"
        continue-on-error: true

  # ============================================
  # PARALLEL BACKEND TESTS
  # ============================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_campus_lms
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/api/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Setup npm for GitHub Packages
        run: |
          # Ensure .npmrc exists and add GitHub Packages config
          if [ -f ~/.npmrc ]; then
            # Remove existing @gkeferstein registry line if present
            sed -i '/@gkeferstein:registry/d' ~/.npmrc
            sed -i '/npm.pkg.github.com\/:_authToken/d' ~/.npmrc
          fi
          echo "@gkeferstein:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "‚úÖ .npmrc configuration:"
          cat ~/.npmrc

      - name: Install Dependencies
        working-directory: packages/api
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Setup Test Database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_campus_lms
        working-directory: packages/api
        run: |
          until pg_isready -h localhost -p 5432 -U test_user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          npx prisma migrate deploy || echo "‚ö†Ô∏è Migrations skipped"

      - name: Run Unit Tests
        id: test
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_campus_lms
        working-directory: packages/api
        run: |
          if npm run test 2>/dev/null; then
            echo "‚úÖ Tests passed"
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Tests not configured or failed (non-critical)"
            echo "has_tests=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        continue-on-error: true

      - name: Upload Test Results
        if: steps.test.outputs.has_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: |
            packages/api/coverage/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # PARALLEL FRONTEND CHECKS (nur bei Frontend-√Ñnderungen)
  # ============================================
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for Frontend Changes
        id: frontend-changes
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Check if frontend files changed
            if git diff --name-only HEAD~1 HEAD | grep -E "^packages/frontend/" > /dev/null; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Frontend changes detected"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No frontend changes detected, skipping checks"
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.frontend-changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/frontend/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Setup npm for GitHub Packages
        if: steps.frontend-changes.outputs.has_changes == 'true'
        run: |
          echo "@gkeferstein:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc

      - name: Install Frontend Dependencies
        if: steps.frontend-changes.outputs.has_changes == 'true'
        working-directory: ./packages/frontend
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Frontend Type Check
        if: steps.frontend-changes.outputs.has_changes == 'true'
        working-directory: ./packages/frontend
        run: npm run typecheck || npx tsc --noEmit || echo "‚ö†Ô∏è Frontend type errors found"
        continue-on-error: true

      - name: Frontend Lint
        if: steps.frontend-changes.outputs.has_changes == 'true'
        working-directory: ./packages/frontend
        run: npm run lint || echo "‚ö†Ô∏è Frontend linting issues found"
        continue-on-error: true

      - name: Frontend Build Test
        id: frontend-build
        if: steps.frontend-changes.outputs.has_changes == 'true'
        working-directory: ./packages/frontend
        env:
          NEXT_PUBLIC_API_URL: https://campus.mojo-institut.de/api
          NEXT_PUBLIC_DIRECTUS_URL: https://campus.mojo-institut.de/cms
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: test_key
        run: npm run build || echo "‚ö†Ô∏è Frontend build failed"
        continue-on-error: true

      - name: Upload Frontend Build Artifacts
        if: steps.frontend-build.outcome == 'success' && steps.frontend-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: packages/frontend/.next
          retention-days: 1
          if-no-files-found: ignore

  # ============================================
  # PARALLEL DATABASE CHECKS
  # ============================================
  database-checks:
    name: Database Migration & Schema Checks
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_campus_lms
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/api/package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Setup npm for GitHub Packages
        run: |
          # Ensure .npmrc exists and add GitHub Packages config
          if [ -f ~/.npmrc ]; then
            # Remove existing @gkeferstein registry line if present
            sed -i '/@gkeferstein:registry/d' ~/.npmrc
            sed -i '/npm.pkg.github.com\/:_authToken/d' ~/.npmrc
          fi
          echo "@gkeferstein:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "‚úÖ .npmrc configuration:"
          cat ~/.npmrc

      - name: Install Dependencies
        working-directory: packages/api
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Setup Test Database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_campus_lms
        working-directory: packages/api
        run: |
          until pg_isready -h localhost -p 5432 -U test_user; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Migration Tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_campus_lms
        working-directory: packages/api
        run: |
          npx prisma migrate status || echo "‚ö†Ô∏è Migration status check skipped"
        continue-on-error: true

      - name: Schema Validation
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_campus_lms
        working-directory: packages/api
        run: |
          npx prisma validate || echo "‚ö†Ô∏è Schema validation skipped"
        continue-on-error: true

  # ============================================
  # BUILD & PUSH DOCKER IMAGES
  # ============================================
  build-images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    needs: [code-quality, backend-tests]
    if: always() && (needs.code-quality.result == 'success' || needs.code-quality.result == 'failure') && (needs.backend-tests.result == 'success' || needs.backend-tests.result == 'failure')
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (API)
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api
          tags: |
            type=sha,prefix=,format=long
            type=raw,value=latest

      - name: Build and push API Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./packages/api
          file: ./packages/api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          build-args: |
            GIT_COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.run_started_at }}
            GIT_BRANCH=${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata (Frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=sha,prefix=,format=long
            type=raw,value=latest

      - name: Determine environment for Frontend
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "api_url=https://campus.mojo-institut.de/api" >> $GITHUB_OUTPUT
            echo "directus_url=https://campus.mojo-institut.de/cms" >> $GITHUB_OUTPUT
          else
            echo "api_url=https://dev.campus.mojo-institut.de/api" >> $GITHUB_OUTPUT
            echo "directus_url=https://dev.campus.mojo-institut.de/cms" >> $GITHUB_OUTPUT
          fi

      - name: Checkout design.mojo (optional)
        uses: actions/checkout@v4
        with:
          repository: gkeferstein/design.mojo
          path: design.mojo
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        id: checkout-design

      - name: Skip design.mojo if not available
        if: steps.checkout-design.outcome == 'failure'
        run: |
          mkdir -p design.mojo/packages/design
          echo '{"name": "@mojo/design", "version": "1.0.0"}' > design.mojo/packages/design/package.json

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ..
          file: campus.mojo/packages/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ steps.env.outputs.api_url }}
            NEXT_PUBLIC_DIRECTUS_URL=${{ steps.env.outputs.directus_url }}
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
            GIT_COMMIT=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp || github.run_started_at }}
            GIT_BRANCH=${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

    outputs:
      api-image: ${{ steps.meta-api.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}

  # ============================================
  # AUTO-DEPLOY
  # ============================================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 1.5
    needs: [build-images]
    if: needs.build-images.result == 'success' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
      url: ${{ github.ref == 'refs/heads/main' && 'https://campus.mojo-institut.de' || 'https://dev.campus.mojo-institut.de' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_SERVER }}" ]; then
            echo "‚ùå Fehler: DEPLOY_SERVER Secret nicht gesetzt!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Fehler: SSH_PRIVATE_KEY Secret nicht gesetzt!"
            exit 1
          fi
          echo "‚úÖ Alle Secrets vorhanden"

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "url=https://campus.mojo-institut.de" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "url=https://dev.campus.mojo-institut.de" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_SERVER }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          export REGISTRY="${{ env.REGISTRY }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_ACTOR="${{ github.actor }}"
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export BRANCH="${{ steps.env.outputs.branch }}"
          export IMAGE_TAG="latest"
          export API_IMAGE="${REGISTRY}/${GITHUB_REPOSITORY}-api:${IMAGE_TAG}"
          export FRONTEND_IMAGE="${REGISTRY}/${GITHUB_REPOSITORY}-frontend:${IMAGE_TAG}"
          
          ssh -T -o StrictHostKeyChecking=no root@${{ secrets.DEPLOY_SERVER }} \
            REGISTRY="${REGISTRY}" \
            GITHUB_REPOSITORY="${GITHUB_REPOSITORY}" \
            GITHUB_ACTOR="${GITHUB_ACTOR}" \
            GITHUB_TOKEN="${GITHUB_TOKEN}" \
            BRANCH="${BRANCH}" \
            IMAGE_TAG="${IMAGE_TAG}" \
            API_IMAGE="${API_IMAGE}" \
            FRONTEND_IMAGE="${FRONTEND_IMAGE}" \
            bash << 'DEPLOY_EOF'
          set -e
          PROJECT_DIR="/root/projects/campus.mojo"
          
          if [ ! -d "$PROJECT_DIR" ]; then
            mkdir -p "$PROJECT_DIR"
          fi
          
          if [ ! -d "$PROJECT_DIR/.git" ]; then
            REPO_URL="https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git clone "$REPO_URL" "$PROJECT_DIR" || exit 1
          fi
          
          cd "$PROJECT_DIR" || exit 1
          git remote set-url origin "https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git fetch origin
          git checkout "$BRANCH"
          git pull origin "$BRANCH"
          
          echo "$GITHUB_TOKEN" | docker login ${REGISTRY} -u ${GITHUB_ACTOR} --password-stdin
          
          if docker compose version >/dev/null 2>&1; then
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose >/dev/null 2>&1; then
            COMPOSE_CMD="docker-compose"
          else
            echo "‚ùå Docker Compose not found!"
            exit 1
          fi
          
          run_compose() {
            eval "$COMPOSE_CMD $*"
          }
          
          # Ensure mojo-network exists
          docker network inspect mojo-network >/dev/null 2>&1 || \
            docker network create mojo-network || true
          
          # Pull new images
          docker image prune -f || true
          docker pull "${API_IMAGE}" || exit 1
          docker pull "${FRONTEND_IMAGE}" || exit 1
          
          # Tag images for docker-compose (optional, if docker-compose.yml uses specific tags)
          docker tag "${API_IMAGE}" campus-api:latest || true
          docker tag "${FRONTEND_IMAGE}" campus-frontend:latest || true
          
          # Stop existing containers
          echo "üõë Stopping existing containers..."
          run_compose down --remove-orphans || true
          
          # Start services with new images
          echo "üöÄ Starting services..."
          run_compose up -d
          
          # Wait for services to be healthy
          MAX_ATTEMPTS=60
          ATTEMPT=1
          while [ "$ATTEMPT" -le "$MAX_ATTEMPTS" ]; do
            API_HEALTH=$(docker inspect campus-api --format='{{.State.Health.Status}}' 2>/dev/null || echo "unhealthy")
            FRONTEND_HEALTH=$(docker inspect campus-frontend --format='{{.State.Health.Status}}' 2>/dev/null || echo "unhealthy")
            
            if [ "$API_HEALTH" = "healthy" ] && [ "$FRONTEND_HEALTH" = "healthy" ]; then
              echo "‚úÖ All services healthy"
              break
            fi
            
            if [ "$ATTEMPT" -eq "$MAX_ATTEMPTS" ]; then
              echo "‚ùå Services not healthy, checking logs..."
              run_compose logs --tail=50
              exit 1
            fi
            
            sleep 2
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # Run migrations
          echo "üîÑ Running database migrations..."
          docker exec campus-api npx prisma migrate deploy || {
            echo "‚ö†Ô∏è Migration failed but continuing..."
          }
          
          echo "‚úÖ Deployment completed successfully"
          DEPLOY_EOF

  # ============================================
  # SMOKE TESTS
  # ============================================
  smoke-tests:
    name: Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: needs.deploy.result == 'success' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "url=https://campus.mojo-institut.de" >> $GITHUB_OUTPUT
          else
            echo "url=https://dev.campus.mojo-institut.de" >> $GITHUB_OUTPUT
          fi
      
      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for services to be fully ready..."
          sleep 30
      
      - name: Health Check - API
        continue-on-error: true
        run: |
          MAX_RETRIES=5
          BASE_URL="${{ steps.env.outputs.url }}"
          HEALTH_URL="$BASE_URL/api/health"
          
          echo "üè• Checking API health at: $HEALTH_URL"
          
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ API Health-Check erfolgreich (HTTP $HTTP_CODE)"
              
              # Get health details
              echo "üìã Health details:"
              curl -s "$HEALTH_URL" | jq '.' || curl -s "$HEALTH_URL"
              exit 0
            fi
            
            echo "‚ö†Ô∏è API Health-Check fehlgeschlagen (HTTP $HTTP_CODE), Versuch $i/$MAX_RETRIES..."
            if [ $i -lt $MAX_RETRIES ]; then
              sleep 15
            fi
          done
          
          echo "‚ùå API Health-Check nach $MAX_RETRIES Versuchen fehlgeschlagen"
          exit 1
      
      - name: Health Check - Frontend
        continue-on-error: true
        run: |
          MAX_RETRIES=5
          BASE_URL="${{ steps.env.outputs.url }}"
          FRONTEND_URL="$BASE_URL"
          
          echo "üåê Checking Frontend at: $FRONTEND_URL"
          
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$FRONTEND_URL" || echo "000")
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
              echo "‚úÖ Frontend erreichbar (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Frontend-Check fehlgeschlagen (HTTP $HTTP_CODE), Versuch $i/$MAX_RETRIES..."
            if [ $i -lt $MAX_RETRIES ]; then
              sleep 15
            fi
          done
          
          echo "‚ùå Frontend-Check nach $MAX_RETRIES Versuchen fehlgeschlagen"
          exit 1
      
      - name: Health Check - Directus CMS
        continue-on-error: true
        run: |
          MAX_RETRIES=3
          BASE_URL="${{ steps.env.outputs.url }}"
          DIRECTUS_URL="$BASE_URL/cms/server/health"
          
          echo "üì¶ Checking Directus CMS at: $DIRECTUS_URL"
          
          for i in $(seq 1 $MAX_RETRIES); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$DIRECTUS_URL" || echo "000")
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ Directus CMS Health-Check erfolgreich (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Directus CMS Health-Check fehlgeschlagen (HTTP $HTTP_CODE), Versuch $i/$MAX_RETRIES..."
            if [ $i -lt $MAX_RETRIES ]; then
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Directus CMS Health-Check fehlgeschlagen (nicht kritisch)"
          exit 0

  # ============================================
  # NOTIFICATIONS
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [code-quality, backend-tests, frontend-checks, database-checks, build-images, deploy, smoke-tests]
    if: always()
    steps:
      - name: Check Pipeline Status
        id: status
        run: |
          if [ "${{ needs.code-quality.result }}" == "failure" ] || \
             [ "${{ needs.backend-tests.result }}" == "failure" ] || \
             [ "${{ needs.build-images.result }}" == "failure" ] || \
             [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Pipeline failed! Check workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Pipeline completed successfully"
          fi

      - name: Check Email Config
        id: email-config
        run: |
          if [ -n "${{ secrets.EMAIL_RECIPIENT }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification (on failure)
        if: steps.status.outputs.status == 'failure' && steps.email-config.outputs.enabled == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå CI Pipeline Failed - campus.mojo"
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: GitHub Actions
          body: |
            Pipeline failed for commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Workflow: ${{ github.workflow }}
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Failed Jobs:
            - Code Quality: ${{ needs.code-quality.result }}
            - Backend Tests: ${{ needs.backend-tests.result }}
            - Frontend Checks: ${{ needs.frontend-checks.result }}
            - Database Checks: ${{ needs.database-checks.result }}
            - Build Images: ${{ needs.build-images.result }}
            - Deploy: ${{ needs.deploy.result }}
            - Smoke Tests: ${{ needs.smoke-tests.result }}
          html_body: |
            <h2>‚ùå CI Pipeline Failed</h2>
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Workflow:</strong> ${{ github.workflow }}</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>
            <h3>Job Results:</h3>
            <ul>
              <li>Code Quality: ${{ needs.code-quality.result }}</li>
              <li>Backend Tests: ${{ needs.backend-tests.result }}</li>
              <li>Frontend Checks: ${{ needs.frontend-checks.result }}</li>
              <li>Database Checks: ${{ needs.database-checks.result }}</li>
              <li>Build Images: ${{ needs.build-images.result }}</li>
              <li>Deploy: ${{ needs.deploy.result }}</li>
              <li>Smoke Tests: ${{ needs.smoke-tests.result }}</li>
            </ul>
        continue-on-error: true

